window['content_list_model_name'] = 'discipline_teaching_plan';
window['content_list_submodel_name'] = 'teaching_plan';

$(function() {
  'use strict';

  var $unity = $('#discipline_teaching_plan_teaching_plan_attributes_unity_id');
  var $grade = $('#discipline_teaching_plan_teaching_plan_attributes_grade_id');
  var $discipline = $('#discipline_teaching_plan_discipline_id');
  var $schoolTermType = $('#discipline_teaching_plan_teaching_plan_attributes_school_term_type_id');
  var $schoolTermContainer = $('#school-term-container');
  var $schoolTerm = $('#discipline_teaching_plan_teaching_plan_attributes_school_term_type_step_id');
  var flashMessages = new FlashMessages();

function handleFetchSchoolTermTypeStepsSuccess(data){
    var steps = _.map(data.school_term_type_steps, function(school_term_type_steps) {
      return { id: school_term_type_steps.id, text: school_term_type_steps.description };
    });

    $schoolTerm.select2({ data: steps });
    $schoolTermContainer.show();
  }

  function handleFetchSchoolTermTypeStepsError() {
    flashMessages.error('Ocorreu um erro ao buscar as etapas');
    $schoolTerm.val('');
    $schoolTermContainer.hide();
  };

  function fetchDisciplines() {
    var unity_id = $unity.select2('val');
    var grade_id = $grade.select2('val');

    $discipline.select2('val', '');
    $discipline.select2({ data: [] });

    if (!_.isEmpty(unity_id) && !_.isEmpty(grade_id)) {
      $.ajax({
        url: Routes.search_disciplines_pt_br_path({
          by_unity_id: unity_id,
          by_grade: grade_id,
          format: 'json'
        }),
        success: handleFetchDisciplinesSuccess,
        error: handleFetchDisciplinesError
      });
    }
  };

  function handleFetchDisciplinesSuccess(data) {
    var disciplines = _.map(data.disciplines, function(discipline) {
      return { id: discipline.id, text: discipline.description };
    });

    $discipline.select2({ data: disciplines });
  };

  function handleFetchDisciplinesError() {
    flashMessages.error('Ocorreu um erro ao buscar as disciplinas da s√©rie selecionada.');
  };

  function updateSchoolTermInput() {
    var school_term_type_id = $schoolTermType.select2('val');

    if (!_.isEmpty(school_term_type_id)) {
      $.ajax({
        url: Routes.steps_by_school_term_type_id_pt_br_path({
          school_term_type_id: school_term_type_id,
          format: 'json'
        }),
        success: handleFetchSchoolTermTypeStepsSuccess,
        error: handleFetchSchoolTermTypeStepsError
      });
    } else {
      $schoolTerm.val('');
      $schoolTermContainer.hide();
    }
  }

  // On change

  $grade.on('change', function() {
    fetchDisciplines();
  });

  $schoolTermType.on('change', function() {
    updateSchoolTermInput();
    $('#copy_plan_info').show();
  });

  // On load

  updateSchoolTermInput();

  validate_attachment_size($('#discipline_teaching_plan'));

  $('#discipline_teaching_plan_teaching_plan_attributes_contents_tags').on('change', function(e){
    if(e.val.length){
      var content_description = e.val.join(", ");
      if(content_description.trim().length &&
          !$('input[type=checkbox][data-content_description="'+content_description+'"]').length){

        var html = JST['templates/layouts/contents_list_manual_item']({
          description: content_description,
          model_name: 'discipline_teaching_plan',
          submodel_name: 'teaching_plan'
        });

        $('#contents-list').append(html);
        $('.list-group.checked-list-box .list-group-item:not(.initialized)').each(initializeListEvents);
      }else{
        var content_input = $('input[type=checkbox][data-content_description="'+content_description+'"]');
        content_input.closest('li').show();
        content_input.prop('checked', true).trigger('change');
      }

      $('.discipline_teaching_plan_teaching_plan_contents_tags .select2-input').val("");
    }
    $(this).select2('val', '');
  });

  $('#discipline_teaching_plan_teaching_plan_attributes_objectives_tags').on('change', function(e){
    if(e.val.length){
      var objective_description = e.val.join(", ");
      if(objective_description.trim().length &&
          !$('input[type=checkbox][data-objective_description="'+objective_description+'"]').length){

        var html = JST['templates/layouts/objectives_list_manual_item']({
          description: objective_description,
          model_name: 'discipline_teaching_plan',
          submodel_name: 'teaching_plan'
        });

        $('#objectives-list').append(html);
        $('.list-group.checked-list-box .list-group-item:not(.initialized)').each(initializeListEvents);
      }else{
        var objective_input = $('input[type=checkbox][data-objective_description="'+objective_description+'"]');
        objective_input.closest('li').show();
        objective_input.prop('checked', true).trigger('change');
      }

      $('.discipline_teaching_plan_teaching_plan_objectives_tags .select2-input').val("");
    }
    $(this).select2('val', '');
  });

  if ($('#action_name').val() == 'show') {
    $('.list-group.checked-list-box .list-group-item').each(function(){
      $(this).off('click');
    });
  }
});
