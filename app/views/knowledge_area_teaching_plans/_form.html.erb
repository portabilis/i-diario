<% content_for :js do %>
  <%= javascript_include_tag 'list-contents' %>
  <%= javascript_include_tag 'attachemnt_size_validator' %>
  <%= javascript_include_tag 'views/knowledge_area_teaching_plans/form' %>
  <%= javascript_include_tag 'views/layouts/copy-objectives' %>
<% end %>

<%= simple_form_for @knowledge_area_teaching_plan, html: { class: 'smart-form', id: 'knowledge_area_teaching_plan' } do |f| %>
  <%= f.error_notification %>
  <%= render 'base_errors', f: f %>

  <%= f.simple_fields_for :teaching_plan, @knowledge_area_teaching_plan.teaching_plan do |teaching_plan_form| %>
    <%= teaching_plan_form.hidden_field :id %>

    <fieldset>
      <%= render 'teaching_plans/copy_objectives', f: teaching_plan_form, type: 'experience_fields' %>

      <div id='copy_plan_info' class='alert alert-info' style='display: none;'>
        <i class='fa-fw fa fa-info'></i>
        <strong><%= t('teaching_plans.infos.copy_plan_info_title') %></strong>
        <span><%= t('teaching_plans.infos.copy_plan_info_description') %></span>
      </div>

      <div class="row">
        <div class="col col-sm-4">
          <%= teaching_plan_form.input :year, readonly: true %>
        </div>
      </div>

      <div class="row">
        <div class="col col-sm-4">
          <%= teaching_plan_form.association :unity, as: :select2_unity, user: current_user %>
        </div>

        <div class="col col-sm-4">
          <%= teaching_plan_form.association :grade, as: :select2_grade, user: current_user %>
        </div>

        <div class="col col-sm-4">
          <%= f.input :knowledge_area_ids, as: :select2,
                elements: @knowledge_areas, multiple: true,
                input_html: { data: { without_json_parser: true } },
                readonly: action_name == 'show' %>
        </div>
      </div>

      <div class="row">
        <div class="col col-sm-4">
          <%= teaching_plan_form.input :school_term_type, as: :select2, elements: SchoolTermTypes.to_select.to_json,
                readonly: action_name == 'show' %>
        </div>

        <div id="school-term-container" class="col col-sm-4">
          <%= teaching_plan_form.input :school_term, as: :select2, elements: [], required: true,
                readonly: action_name == 'show' %>
        </div>

        <div class="col col-sm-4">
          <%= f.input :experience_fields, readonly: action_name == 'show' %>
        </div>
      </div>

      <div class="row textarea">
        <div class="col col-sm-12">
          <legend style="margin-bottom: 10px;">
            <%= @knowledge_area_teaching_plan.class.human_attribute_name(:contents) %>
          </legend>
          <% if f.object.errors[:'teaching_plan.contents'].any? %>
            <div class="alert alert-danger fade in">
              <i class="fa-fw fa fa-times"></i>
              <%= f.object.errors[:'teaching_plan.contents'].first %>
            </div>
          <% end %>

            <div class="well" style="max-height: 300px;overflow-y: auto; margin-top: 10px;">
              <ul class="list-group checked-list-box" id="contents-list">

                <% contents.each do |content| %>
                  <li class="list-group-item manual" style="display: flex;" id="teaching_plan_<%= content.id %>">
                    <%= check_box_tag("knowledge_area_teaching_plan[teaching_plan_attributes][content_ids][]",
                        content.id, content.id.in?(@knowledge_area_teaching_plan.contents.collect(&:id)),
                        hidden: true, 'data-content_description': content.to_s ) %>
                    <span style="margin-left: 5px;display: block;width: calc(100% - 85px);"><%= content %></span>
                    <% if content.is_editable && action_name != 'show' %>
                      <div style="width: 80px;">
                        <a class="btn new-btn-success" onclick="editContent('teaching_plan_<%= content.id %>')">
                          <i class="fa fa-pencil"></i>
                        </a>
                        <a class="btn new-btn-danger" onclick="removeContent('teaching_plan_<%= content.id %>')">
                          <i class="fa fa-trash"></i>
                        </a>
                      </div>
                    <% end %>
                  </li>
                <% end %>
              </ul>
            </div>

        </div>
      </div>
      <% if action_name != 'show' %>
      <div class="row textarea">
        <div class="col col-sm-12 contents-select2-container">
          <%= teaching_plan_form.input :contents_tags,
              as: :string,
              input_html: {
                'data-content-type': 'conteúdo',
                class: 'select2-tags',
                value: ''
              }
          %>
        </div>
      </div>
      <% end %>

      <div class="row textarea">
        <div class="col col-sm-12">
          <legend style="margin-bottom: 10px;">
            <%= @knowledge_area_teaching_plan.class.human_attribute_name(:objectives) %>
          </legend>
          <% if f.object.errors[:'teaching_plan.objectives'].any? %>
            <div class="alert alert-danger fade in">
              <i class="fa-fw fa fa-times"></i>
              <%= f.object.errors[:'teaching_plan.objectives'].first %>
            </div>
          <% end %>

          <% if action_name != 'show' %>
            <a href="#" data-toggle="modal" data-target="#copy-objectives-modal">
              Copiar objetivos/habilidades por área
            </a>
          <% end %>

            <div class="well" style="max-height: 300px;overflow-y: auto; margin-top: 10px;">
              <ul class="list-group checked-list-box" id="objectives-list">

                <% objectives.each do |objective| %>
                  <li class="list-group-item manual" style="display: flex;" id="teaching_plan_<%= objective.id %>">
                    <%= check_box_tag("knowledge_area_teaching_plan[teaching_plan_attributes][objective_ids][]",
                        objective.id, objective.id.in?(@knowledge_area_teaching_plan.objectives.collect(&:id)),
                        hidden: true, 'data-objective_description': objective.to_s ) %>
                    <span style="margin-left: 5px;display: block;width: calc(100% - 85px);"><%= objective %></span>
                    <% if objective.is_editable && action_name != 'show' %>
                      <div style="width: 80px;">
                        <a class="btn new-btn-success"
                          onclick="editObjective('teaching_plan_<%= objective.id %>')">
                          <i class="fa fa-pencil"></i>
                        </a>
                        <a class="btn new-btn-danger"
                          onclick="removeObjective('teaching_plan_<%= objective.id %>')">
                          <i class="fa fa-trash"></i>
                        </a>
                      </div>
                    <% end %>
                  </li>
                <% end %>
              </ul>
            </div>

        </div>
      </div>
      <% if action_name != 'show' %>
      <div class="row textarea">
        <div class="col col-sm-12 objectives-select2-container">
          <%= teaching_plan_form.input :objectives_tags,
              as: :string,
              input_html: {
                class: 'select2-content-tags-ajax',
                value: '',
                data: {
                  url: contents_path,
                  data: []
                }
              }
          %>
        </div>
      </div>
      <% end %>

      <div class="row textarea">
        <div class="col col-sm-12">
          <%= teaching_plan_form.input :methodology, input_html: { class: 'col col-sm-12' },
                readonly: action_name == 'show' %>
        </div>
      </div>

      <div class="row textarea">
        <div class="col col-sm-12">
          <%= teaching_plan_form.input :evaluation, input_html: { class: 'col col-sm-12' },
                readonly: action_name == 'show' %>
        </div>
      </div>

      <div class="row textarea">
        <div class="col col-sm-12">
          <%= teaching_plan_form.input :references, input_html: { class: 'col col-sm-12' },
                readonly: action_name == 'show' %>
        </div>
      </div>

      <div class="row textarea">
        <div class="col col-sm-12">
          <legend><%= t('.attachments') %></legend>
          <div class="alert alert-info fade in">
            <i class="fa-fw fa fa-info"></i>
            <%= t('.format_message') + ' ' + t('.size_message') %>
          </div>
          <br>
          <% if teaching_plan_form.object.errors[:teaching_plan_attachments].present? %>
            <div class="alert alert-danger alert-block ">
              <i class="fa-fw fa fa-times"></i>
              <span class="help-inline">
                <%= teaching_plan_form.object.errors[:teaching_plan_attachments].join "<br />" %>
              </span>
            </div>
          <% end %>
          <table class="table table-striped table-bordered table-condensed records">
            <thead>
              <tr>
                <th>Anexo</th>
                <td width="73px"></td>
              </tr>
            </thead>

            <tbody id="teaching-plan-attachments">
              <%= teaching_plan_form.simple_fields_for :teaching_plan_attachments, teaching_plan_form.object.teaching_plan_attachments do |attachment| %>
                <% if attachment.object.persisted? %>
                  <%= render 'teaching_plan_attachment_show', f: attachment %>
                <% else %>
                  <%= render 'teaching_plan_attachment_fields', f: attachment %>
                <% end %>
              <% end %>
            </tbody>
            <tfoot class="links">
              <tr>
                <td colspan="2">
                  <%= link_to_add_association t('.add_attachment'), teaching_plan_form, :teaching_plan_attachments,
                    class: 'btn btn-success btn-sm',
                    :"data-association-insertion-method" => "append",
                    :"data-association-insertion-node" => "#teaching-plan-attachments" %>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </fieldset>
  <% end %>

  <footer>
    <%= link_to t('views.form.back'), knowledge_area_teaching_plans_path, class: 'btn btn-default' %>
    <%= link_to t('views.form.history'), history_knowledge_area_teaching_plan_path(@knowledge_area_teaching_plan), class: 'btn btn-info' if @knowledge_area_teaching_plan.persisted? %>
    <%= f.submit t('views.form.save'), class: 'btn btn-primary' unless action_name == 'show' %>
  </footer>
<% end %>
